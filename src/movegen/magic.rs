use crate::types::{bitboard::Bitboard, square::Square};

use super::lookups::BLOCKER_MASKS;

// just the max number of moves each piece can make (dead center r/b, back rank lance & no blockers)
const LANCE_SHIFT: usize = 7;
const ROOK_SHIFT: usize = 14;
const BISHOP_SHIFT: usize = 12;

const LANCE_BLOCKERS: usize = 1 << LANCE_SHIFT;
const ROOK_BLOCKERS: usize = 1 << ROOK_SHIFT;
const BISHOP_BLOCKERS: usize = 1 << BISHOP_SHIFT;

static LANCE_ATTACKS: [[[Bitboard; 2]; LANCE_BLOCKERS]; 81] =
    unsafe { std::mem::transmute(*include_bytes!("./magic/lance_attacks.bin")) };
static ROOK_ATTACKS: [[Bitboard; ROOK_BLOCKERS]; 81] =
    unsafe { std::mem::transmute(*include_bytes!("./magic/rook_attacks.bin")) };
static BISHOP_ATTACKS: [[Bitboard; BISHOP_BLOCKERS]; 81] =
    unsafe { std::mem::transmute(*include_bytes!("./magic/bishop_attacks.bin")) };

pub fn get_lance_attacks_internal(sq: Square, occ: Bitboard, stm: u8) -> Bitboard {
    let blockers = occ & Bitboard(BLOCKER_MASKS[stm as usize][sq.as_usize()]);
    let idx = ((blockers
        .0
        .overflowing_mul(LANCE_MAGICS[stm as usize][sq.as_usize()]))
    .0 & Bitboard::FULL.0)
        >> (81 - LANCE_SHIFT);
    LANCE_ATTACKS[sq.as_usize()][idx as usize][stm as usize]
}

pub fn get_rook_attacks_internal(sq: Square, occ: Bitboard) -> Bitboard {
    let blockers = occ & Bitboard(BLOCKER_MASKS[3][sq.as_usize()]);
    let idx = ((blockers.0.overflowing_mul(ROOK_MAGICS[sq.as_usize()])).0 & Bitboard::FULL.0)
        >> (81 - ROOK_SHIFT);
    ROOK_ATTACKS[sq.as_usize()][idx as usize]
}

pub fn get_bishop_attacks_internal(sq: Square, occ: Bitboard) -> Bitboard {
    let blockers = occ & Bitboard(BLOCKER_MASKS[2][sq.as_usize()]);
    let idx = ((blockers.0.overflowing_mul(BISHOP_MAGICS[sq.as_usize()])).0 & Bitboard::FULL.0)
        >> (81 - BISHOP_SHIFT);
    BISHOP_ATTACKS[sq.as_usize()][idx as usize]
}
const LANCE_MAGICS: [[u128; 81]; 2] = [
    [
        10194502017933093372238,
        443963134339884184502320,
        689837006778911441289472,
        152028944172202605019158,
        454573026427370909892608,
        607137707067574884237320,
        399216544945746487603202,
        19498535077010928304129,
        94596061055462287360000,
        606910004016578341898562,
        302707324521735665365025,
        229196798312055407642241,
        1966432718232355424719424,
        1549245354007666138040329,
        840605823886512205138192,
        342740509569070911848992,
        231415857255934786113893,
        321324141352752207429688,
        304613476323684843291975,
        153478244890598956868354,
        1383082972354545766635862,
        226969915092058929629952,
        2656331259132019480661,
        1208965254985664306397696,
        265054944265342027959401,
        1360336715414926396588096,
        25982329408750127944202,
        304894733420732453492788,
        623943901178086132842504,
        756317714140731835960352,
        12078154346698131123266,
        161817749773977779243398,
        644612286001959540699206,
        118391206943152443753025,
        1242222204648091218624808,
        114708916439703024281125,
        1383665097891051361838102,
        155257329202492258931377,
        759723859606022807406050,
        340021963390403999974562,
        181812281451641295274242,
        1367130600384327726957339,
        604462923407391349014928,
        680410778965707922125910,
        94464925221195569563874,
        822822812162859162796242,
        1308474847778537626477200,
        609191905729876693889462,
        44869723445831204643094,
        341043445582951265370379,
        152827241118880170906507,
        10035108258763852895244,
        1227853341567996515420289,
        1815974012934232850377798,
        60268274774744418550288,
        13577182335657159442944,
        925737208668555951611920,
        170374273085323677407008,
        40662118374881052725410,
        4724028463640666141717,
        1308298511642283838555140,
        1917986389367279096742208,
        12423937342815561613472,
        160569695083788837718353,
        20154293233712701112328,
        945211311578038959472698,
        18879090190383645792,
        767680730448615784718372,
        355657772301965359874344,
        360302860919906635096720,
        643450471576648503087232,
        45472464109532839092504,
        323685974749756532998148,
        40157032032006398542370,
        303491527354628230350889,
        152891298670519986946257,
        909538626575261149167724,
        96820053381672353962304,
        4909140048247739795637,
        114153084495836053773828,
        759130901009741117858056,
    ],
    [
        389919282692938155557120,
        133406925392175612051585,
        237300108130169082904642,
        871332186014048841642816,
        377868295059658166972417,
        606836055111107717648385,
        609499307929682772754530,
        87548329004180185418005,
        359084468764309427716352,
        1851342949556305608709122,
        42538426032165116576966,
        906971357128314041936210,
        642575626133538317467672,
        626451538333812080560451,
        887317215328717648146,
        2364104681288420179978,
        49585138588608316907714,
        604463135095187723784272,
        7268017345395885604944,
        383128570177204221871110,
        155262209716473135899188,
        1511397181834392756277280,
        1553771856413634995438176,
        1362513995748256256163918,
        1554269729524469419549696,
        482062011421904486408242,
        61701080464819094588497,
        212893945563274427957776,
        906989659335279637570690,
        327329477491935295177730,
        642982929853327348206081,
        1256889815177729535773314,
        1381299852930572587649024,
        453651582926166023647330,
        3101037057181203334668,
        458240622587167374245904,
        42208624159448121741849,
        164179195359058567626858,
        784376923728857351145732,
        1458625743765701669164552,
        188962691394513163852050,
        77790506951534166671502,
        1211349801051810942175240,
        759353103802943766950,
        2116088271101408143681540,
        38988829110721719828803,
        869413867611166234394752,
        1284780615859679042931780,
        31583141179943177965664,
        95642409657746789367810,
        1314029137933587565510725,
        303597102037810968479774,
        558754184469840901780482,
        1364925908085134088814656,
        1559640092322966764863506,
        10146869798040540026160,
        1607375600390307798389408,
        330639774162566844150272,
        757972521173799496945680,
        59103695812887312334920,
        918588061313298659280946,
        242185160077690144274954,
        37837481051341921114155,
        692528334872350879767595,
        153621101920155582103618,
        43396074505101496049931,
        8270484820646273990688,
        19526060234777613373685,
        1058640293744554157946952,
        2224836439662519141992528,
        8878324253379244326976,
        691540769717509873308261,
        1596164485324788444247296,
        1383654574095940169633024,
        1058991117820135613937795,
        369007293699387818552,
        85592933597805663521537,
        168824709884242795497472,
        2213612262340230783536,
        40140130344035600699852,
        75705463886480347766849,
    ],
];
const ROOK_MAGICS: [u128; 81] = [
    2361184371765056176129,
    2118571673540189384344346,
    1965094825304676179656736,
    1517060376948204374196236,
    493782463379593293221920,
    9444756048925061809152,
    1058990902225899553292416,
    1605604613218074877831426,
    1400181666692044999918080,
    492899307493920044777473,
    57076622404534697757992,
    959913221652418348450848,
    2370694920882404458640,
    609287022151728634005556,
    1533201133915411667036196,
    2129953305034974684975618,
    28364229181322160278144,
    2273824650108513113080000,
    302748684454450568642561,
    1342000886453379269700,
    302840198021675594424505,
    368349559890050291499022,
    605090101920643527221248,
    1860939301540479830786054,
    973092771554936225928,
    85298178209670245123492,
    4844580666060967430149,
    1234036456749163991859204,
    689640895246357447664681,
    235385138144212440748352,
    75779302945524847479844,
    153523207719423490164736,
    420945485190506450817105,
    607397167129318505652513,
    5313861597777004363800,
    161777954744741577896001,
    1703005144608068870865024,
    618631825409813189574656,
    1208926540190899428854814,
    113364501874654532616841,
    316056435144459469209864,
    1239695638373968984934161,
    49884626803276773360272,
    1550329080830683551228032,
    923542007222940865817676,
    40145341532189279389520,
    158243124223479604314138,
    165458115020147781536000,
    9741038317218809512965,
    228151641616018711904264,
    116448001614090993987,
    429775143765537038799360,
    229041712500569392951857,
    303486725635970347040849,
    1341152658252415975641088,
    756777675949396826726528,
    340056503917113302384746,
    512376837718899546996740,
    907663107006876200480776,
    151485241116503341797890,
    381331418034660142489602,
    840620529002147461464080,
    1114540752257278234607620,
    322305577237125869503488,
    1504068295651859436176,
    1247961806338745920688224,
    1813389748933668180595712,
    20229558356032226361488,
    302250559666476287105536,
    302249948540545760493984,
    1514736091725152072832256,
    1106876711710383584256,
    38452278595857927898179,
    38385368576581693346009,
    198340621833596611856946,
    606234950230299254417562,
    190379695510023571603474,
    464046293991973481480843,
    1223173119447977423046790,
    1246904603214741060452425,
    1097293357288205158859202,
];
const BISHOP_MAGICS: [u128; 81] = [
    909058523146518312601000,
    611569521656071872741440,
    1888953654849368700747841,
    170452580971265438908481,
    40769646628772891887656,
    680799717251938384905376,
    1572553749519351803810304,
    333223518581553340026914,
    1211292499571530370122112,
    96230322909695021699968,
    1326100119447840409793801,
    173031811476450921416712,
    1222668727461063530657280,
    182079742975352659509248,
    29588977211244556592448,
    10819134049869030688658,
    227155099238388298485760,
    42953532440040807080036,
    907284663345557234915074,
    624533699480535684950672,
    1231412832995186663506432,
    78301817052037108924433,
    1842977597554514901344800,
    1223185318344805543272451,
    755763848511890588437568,
    1360096889621448846532681,
    2120430389051224004526545,
    629997840202580677242016,
    228155023610635648867144,
    727558060456157423676672,
    409075865773878052177960,
    17745768368661787320340,
    1229733756218587385708840,
    1535713734703836024801286,
    19406128380597257644064,
    1616684251910154584932480,
    1210412262116586801956877,
    1266185089786287525200896,
    794025494664510158873729,
    459028815564487421853960,
    604758129805275479147520,
    518823763574614262016,
    321436404199699803801612,
    964556155097965595396224,
    911721684619654893674518,
    1230178128663228126894344,
    1483017906007975178770,
    37926600606780798273090,
    13911511198840289061995,
    47299257783901150003216,
    359195082848975534579714,
    3562600774018367898657,
    692426223566372914100233,
    160929431503785840631825,
    1271073009754186547466432,
    966339759807285253639756,
    56909365708349444755714,
    349455139198117442297952,
    321269136562255986524874,
    1259630660629643658514,
    3541919892508473631897,
    25973466016906626775040,
    644652602931148256512107,
    604611357460665085732181,
    322343096173771986575360,
    2060210779910716029702400,
    153776688444107001028616,
    1513556586122711953707522,
    19258401947786366972576,
    510020428285091066161224,
    1039068797544629008433810,
    2269406708838511336202240,
    233886844870966449815617,
    661138531534593516651072,
    1365079287156051571392513,
    906699129819063378020936,
    473285095571093396147844,
    1787415929941432197061696,
    19335831201621170193443,
    1246910136486035668866048,
    1316970727839466053074048,
];
